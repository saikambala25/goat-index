<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LivestockMart - Admin App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Updated Modal Styles */
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-scroll { overflow-y: auto; padding-right: 8px; }
        .modal-scroll::-webkit-scrollbar { width: 6px; }
        .modal-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-scroll::-webkit-scrollbar-thumb { background: #c0c0c0; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 h-screen flex overflow-hidden">

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-10 hidden md:flex">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white font-bold">L</div>
            <div>
                <span class="block text-lg font-bold text-gray-800 leading-none">LivestockMart</span>
                <span class="text-xs text-gray-500 font-medium">Admin</span>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-2 mt-4">
            <button onclick="adminRouter('dashboard')" class="admin-nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-green-50 hover:text-green-700 rounded-lg transition-colors">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i> Dashboard
            </button>
            <button onclick="adminRouter('livestock')" class="admin-nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-green-50 hover:text-green-700 rounded-lg transition-colors">
                <i data-lucide="package" class="w-5 h-5"></i> Livestock
            </button>
            <button onclick="adminRouter('orders')" class="admin-nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-green-50 hover:text-green-700 rounded-lg transition-colors">
                <i data-lucide="shopping-cart" class="w-5 h-5"></i> Orders
            </button>
            <button onclick="adminRouter('customers')" class="admin-nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-green-50 hover:text-green-700 rounded-lg transition-colors">
                <i data-lucide="users" class="w-5 h-5"></i> Customers
            </button>
            <button onclick="adminRouter('settings')" class="admin-nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-green-50 hover:text-green-700 rounded-lg transition-colors">
                <i data-lucide="settings" class="w-5 h-5"></i> Settings
            </button>
        </nav>

        <div class="p-4">
            <button onclick="alert('Logged Out')" class="w-full flex items-center gap-3 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg">
                <i data-lucide="log-out" class="w-5 h-5"></i> Logout
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden">
        <header class="bg-white border-b border-gray-200 px-8 py-4 flex justify-between items-center z-10">
            <div>
                <h1 id="admin-page-title" class="text-2xl font-bold text-gray-800">Dashboard</h1>
                <p class="text-sm text-gray-500">Wednesday, Dec 3, 2025</p>
            </div>
            <div class="flex items-center gap-6">
                <button class="flex items-center gap-2 bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium">
                    <i data-lucide="download" class="w-4 h-4"></i> Report
                </button>
                <div class="flex items-center gap-3 border-l pl-6">
                    <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">AU</div>
                    <div>
                        <p class="text-sm font-semibold">Admin User</p>
                        <p class="text-xs text-gray-500">Super Admin</p>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div id="admin-view-dashboard" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Total Livestock</p>
                            <h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-livestock">0</h3>
                        </div>
                        <div class="p-3 bg-blue-50 text-blue-600 rounded-lg">
                            <i data-lucide="package" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Total Orders</p>
                            <h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-orders">0</h3>
                        </div>
                        <div class="p-3 bg-green-50 text-green-600 rounded-lg">
                            <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <div onclick="openDeliveredOrdersModal()" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex items-start justify-between cursor-pointer hover:shadow-lg transition-shadow">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Delivered Revenue (INR)</p>
                            <h3 class="text-3xl font-bold text-gray-800 mt-2" id="stat-revenue">₹0</h3>
                        </div>
                        <div class="p-3 bg-yellow-50 text-yellow-600 rounded-lg">
                            <i data-lucide="wallet" class="w-6 h-6"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="admin-view-livestock" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">All Livestock Listings</h2>
                    <button onclick="openLivestockModal()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700">
                        <i data-lucide="plus" class="w-4 h-4"></i> Add New
                    </button>
                </div>
                <div id="livestock-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>

            <div id="admin-view-orders" class="hidden space-y-6">
                <h2 class="text-xl font-bold text-gray-800">All Customer Orders</h2>
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-500 text-sm uppercase">
                            <tr>
                                <th class="px-6 py-4 font-medium">ID</th>
                                <th class="px-6 py-4 font-medium">Customer</th>
                                <th class="px-6 py-4 font-medium">Date</th>
                                <th class="px-6 py-4 font-medium">Amount (INR)</th>
                                <th class="px-6 py-4 font-medium">Status</th>
                                <th class="px-6 py-4 font-medium text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="divide-y divide-gray-100 text-sm">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="admin-view-customers" class="hidden space-y-6">
                <h2 class="text-xl font-bold text-gray-800">All Customers</h2>
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-500 text-sm uppercase">
                            <tr>
                                <th class="px-6 py-4 font-medium">Name</th>
                                <th class="px-6 py-4 font-medium">Email</th>
                                <th class="px-6 py-4 font-medium">Role</th>
                                <th class="px-6 py-4 font-medium">Joined</th>
                            </tr>
                        </thead>
                        <tbody id="customers-table-body" class="divide-y divide-gray-100 text-sm">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="admin-view-settings" class="hidden space-y-6">
                <div class="bg-white p-6 rounded-xl border shadow-sm text-center py-12">
                    <i data-lucide="settings" class="w-12 h-12 mx-auto text-green-600 mb-4"></i>
                    <h3 class="font-bold text-lg">Admin Settings</h3>
                    <p class="text-gray-500 mt-1">Configure user roles, platform fees, and other system parameters.</p>
                </div>
            </div>
        </div>
    </main>

    <div id="livestock-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Add New Livestock</h3>
            <img id="preview-image" src="" class="w-full h-48 object-cover rounded-lg mb-4 hidden">
            <div class="modal-scroll flex-1">
                <form onsubmit="event.preventDefault();">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name</label>
                            <input id="new-name" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Type</label>
                            <select id="new-type" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option value="">Select Type</option>
                                <option value="Goat">Goat</option>
                                <option value="Sheep">Sheep</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Breed</label>
                            <input id="new-breed" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Age</label>
                                <input id="new-age" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., 6 months">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Price (INR)</label>
                                <input id="new-price" type="number" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., 25000">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="new-status" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option value="Available">Available</option>
                                <option value="Sold">Sold</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tags (comma separated)</label>
                            <input id="new-tags" type="text" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="e.g., New Arrival, Premium">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Upload Image</label>
                            <input id="new-image" type="file" accept="image/*" onchange="previewImage(this)" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                </form>
            </div>
            <div class="mt-6 flex justify-end space-x-3 pt-4 border-t">
                <button type="button" onclick="closeLivestockModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-livestock-btn" type="button" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Add Livestock</button>
            </div>
        </div>
    </div>

    <div id="delivered-orders-modal" class="modal">
        <div class="modal-content !w-11/12 max-w-2xl">
            <h3 class="text-xl font-bold mb-4 text-green-700 flex items-center gap-2">
                <i data-lucide="check-square" class="w-6 h-6"></i> Successful Deliveries (Delivered)
            </h3>
            <p class="text-sm text-gray-500 mb-4">Total revenue is based on the sum of these orders, grouped by customer.</p>
            <div id="delivered-orders-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeDeliveredOrdersModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <div id="order-details-modal" class="modal">
        <div class="modal-content !w-11/12 max-w-4xl">
            <h3 class="text-xl font-bold mb-4 text-blue-700 flex items-center gap-2">
                <i data-lucide="file-text" class="w-6 h-6"></i> Order Details
            </h3>
            <div id="order-details-content" class="modal-scroll max-h-[65vh] space-y-6">
                </div>
            <div class="mt-6 flex justify-end space-x-3 pt-4 border-t">
                <button type="button" onclick="closeOrderDetailsModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <script>
        let livestock = [];
        let orders = [];
        let customers = [];
        // NEW: Store the last viewed route for persistence after data reload
        let lastViewedRoute = 'dashboard'; 
        
        const API_URL = 'https://goat-user.vercel.app/api'; 

        function formatINR(amount) {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(amount);
        }

        function previewImage(input) {
            const preview = document.getElementById('preview-image');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function openLivestockModal(isEdit = false, id = null) {
            let item = null;
            if (isEdit && id) {
                item = livestock.find(i => i._id === id);
                if (!item) return;
            }
            const modal = document.getElementById('livestock-modal');
            const title = modal.querySelector('h3');
            title.innerText = isEdit ? 'Edit Livestock' : 'Add New Livestock';
            const saveBtn = document.getElementById('save-livestock-btn');
            saveBtn.innerText = isEdit ? 'Update Livestock' : 'Add Livestock';
            saveBtn.onclick = () => saveLivestock(isEdit, item?._id);
            const preview = document.getElementById('preview-image');
            if (isEdit && item) {
                document.getElementById('new-name').value = item.name;
                document.getElementById('new-type').value = item.type || '';
                document.getElementById('new-breed').value = item.breed;
                document.getElementById('new-age').value = item.age;
                document.getElementById('new-price').value = item.price;
                document.getElementById('new-status').value = item.status;
                document.getElementById('new-tags').value = item.tags ? item.tags.join(', ') : '';
                preview.src = `${API_URL}/livestock/image/${item._id}`;
                preview.classList.remove('hidden');
            } else {
                modal.querySelector('form').reset();
                preview.classList.add('hidden');
            }
            modal.style.display = 'flex';
        }

        function closeLivestockModal() {
            document.getElementById('livestock-modal').style.display = 'none';
        }

        function openDeliveredOrdersModal() {
            renderDeliveredOrders();
            document.getElementById('delivered-orders-modal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeDeliveredOrdersModal() {
            document.getElementById('delivered-orders-modal').style.display = 'none';
        }

        // UPDATED: openOrderDetailsModal to show rich item details
        function openOrderDetailsModal(id) {
            const order = orders.find(o => o._id === id);
            if (!order) return;

            const content = document.getElementById('order-details-content');

            let itemsHTML = '';
            for (const item of order.items) {
                itemsHTML += `
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 flex gap-4">
                        <div class="w-32 h-32 bg-gray-200 rounded-lg flex-shrink-0">
                            <img src="${API_URL}/livestock/image/${item._id}" 
                                alt="${item.name}" 
                                class="w-full h-full object-cover rounded-lg"
                                onerror="this.src='https://via.placeholder.com/150?text=No+Image';">
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-lg">${item.name}</h4>
                            <p class="text-sm text-gray-600">Type: ${item.type || 'N/A'}</p>
                            <p class="text-sm text-gray-600">Breed: ${item.breed}</p>
                            <p class="text-sm text-gray-600">Age: ${item.age || 'N/A'}</p>
                            <p class="text-xl font-bold text-green-700 mt-2">${formatINR(item.price)}</p>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Order ID</p>
                            <p class="font-bold">#${order._id.slice(-6)}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Date</p>
                            <p class="font-bold">${order.date}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Customer</p>
                            <p class="font-bold">${order.customer}</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Status</p>
                            <span class="inline-flex items-center gap-1.5 py-1 px-3 rounded-full text-xs font-medium ${getStatusColor(order.status)}">
                                ${order.status}
                            </span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Shipping Address</p>
                            <p class="font-medium">${order.address?.name || 'N/A'}, ${order.address?.phone || ''}</p>
                            <p class="text-sm text-gray-600">${order.address?.line1 || ''}, ${order.address?.city || ''}, ${order.address?.state || ''} - ${order.address?.pincode || ''}</p>
                        </div>
                        <div class="pt-4 border-t">
                            <div class="flex justify-between text-lg font-bold">
                                <span>Total Amount</span>
                                <span class="text-green-700">${formatINR(order.total)}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h4 class="font-bold text-xl mb-4">Ordered Items</h4>
                    <div class="space-y-4">
                        ${itemsHTML || '<p class="text-gray-500">No items found.</p>'}
                    </div>
                </div>
            `;

            document.getElementById('order-details-modal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeOrderDetailsModal() {
            document.getElementById('order-details-modal').style.display = 'none';
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Shipped': return 'bg-blue-100 text-blue-800';
                case 'Delivered': return 'bg-green-100 text-green-800';
                case 'Processing': return 'bg-yellow-100 text-yellow-800';
                case 'Cancelled': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // FIX: Load data now accepts a callback route to re-render the last active page
        async function loadData(targetRoute = lastViewedRoute) {
            try {
                const [livestockRes, ordersRes, usersRes] = await Promise.all([
                    fetch(`${API_URL}/admin/livestock`).then(res => res.json()),
                    fetch(`${API_URL}/admin/orders`).then(res => res.json()),
                    fetch(`${API_URL}/admin/users`).then(res => res.json())
                ]);

                livestock = livestockRes.livestock || [];
                orders = ordersRes.orders || [];
                customers = usersRes.users || [];
                
                // Update dashboard stats
                document.getElementById('stat-livestock').innerText = livestock.length;
                document.getElementById('stat-orders').innerText = orders.length;
                
                const totalRevenue = orders.filter(o => o.status === 'Delivered').reduce((sum, order) => sum + (order.total || 0), 0);
                document.getElementById('stat-revenue').innerText = formatINR(totalRevenue); 

                // FIX: Instead of looking up the active view, use the targetRoute passed or the lastViewedRoute
                adminRouter(targetRoute);

            } catch (error) {
                console.error("Error loading data:", error);
                alert("Failed to load data from server. Check console for details.");
            }
        }
        
        // FIX: RenderLivestock to use Image API
        function renderLivestock() {
            const grid = document.getElementById('livestock-grid');
            if (!grid) return;
            
            if (livestock.length === 0) {
                grid.innerHTML = '<div class="col-span-3 text-center text-gray-500 p-12">No livestock listings found.</div>';
                return;
            }

            grid.innerHTML = livestock.map(item => `
                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm relative">
                    <div class="h-40 bg-gray-100 rounded-lg flex items-center justify-center text-6xl mb-4">
                        <img src="${API_URL}/livestock/image/${item._id}" alt="${item.name}" class="w-full h-full object-cover rounded-lg" onerror="this.src='https://via.placeholder.com/160'; this.onerror=null;">
                    </div>
                    <h3 class="font-bold text-lg text-gray-800">${item.name}</h3>
                    <p class="text-xs text-gray-500 mt-1">${item.breed} • ${item.age}</p>
                    <span class="absolute top-4 right-4 bg-yellow-500/10 text-yellow-700 text-xs px-2 py-1 rounded-full font-medium">${item.status}</span>
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-xl font-bold text-green-700">${formatINR(item.price)}</span>
                        <div class="flex gap-2">
                            <button onclick="openLivestockModal(true, '${item._id}')" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600 transition">Edit</button>
                            <button onclick="removeItem('${item._id}')" class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-red-600 transition">Remove</button>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        
        // UPDATED: renderOrders to show 6 characters of ID and use the updated modal function
        function renderOrders() {
            const tableBody = document.getElementById('orders-table-body');
            if (!tableBody) return;

            if (orders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No orders found.</td></tr>';
                return;
            }

            tableBody.innerHTML = orders.map(order => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <span class="font-bold text-gray-800">${order._id.slice(-6)}</span><br>
                        <a onclick="openOrderDetailsModal('${order._id}')" class="text-xs text-blue-600 hover:underline cursor-pointer">Click to see details</a>
                    </td>
                    <td class="px-6 py-4">${order.customer}</td>
                    <td class="px-6 py-4">${order.date}</td>
                    <td class="px-6 py-4 font-bold text-green-700">${formatINR(order.total)}</td> 
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center gap-1.5 py-1 px-3 rounded-full text-xs font-medium ${getStatusColor(order.status)}">
                            ${order.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="nextStatus('${order._id}', '${order.status}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium disabled:text-gray-400" ${order.status === 'Delivered' || order.status === 'Cancelled' ? 'disabled' : ''}>
                            ${order.status === 'Delivered' ? 'Completed' : order.status === 'Cancelled' ? 'Cancelled' : 'Next Status'}
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function renderCustomers() {
            const tableBody = document.getElementById('customers-table-body');
            if (!tableBody) return;

            if (customers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No customers found.</td></tr>';
                return;
            }

            tableBody.innerHTML = customers.map(user => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-bold flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-semibold">${user.name.charAt(0).toUpperCase()}</div>
                        ${user.name}
                    </td>
                    <td class="px-6 py-4">${user.email}</td>
                    <td class="px-6 py-4 text-gray-500">Customer</td>
                    <td class="px-6 py-4">${new Date(user.createdAt).toLocaleDateString()}</td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function renderDeliveredOrders() {
            const deliveredOrders = orders.filter(o => o.status === 'Delivered');
            const listContainer = document.getElementById('delivered-orders-list');
            
            if (deliveredOrders.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 p-8 border border-dashed rounded-lg">No successful deliveries found yet.</p>';
                return;
            }

            // Group orders by customer name
            const ordersByCustomer = deliveredOrders.reduce((acc, order) => {
                const customerName = order.customer || 'Unknown Customer';
                if (!acc[customerName]) {
                    acc[customerName] = [];
                }
                acc[customerName].push(order);
                return acc;
            }, {});

            let html = '';
            for (const customerName in ordersByCustomer) {
                const customerOrders = ordersByCustomer[customerName];
                const customerTotal = customerOrders.reduce((sum, order) => sum + (order.total || 0), 0);

                html += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-center pb-2 border-b border-green-100 mb-3">
                            <h4 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                <i data-lucide="user" class="w-4 h-4 text-green-600"></i> ${customerName}
                            </h4>
                            <span class="text-xl font-bold text-green-700">${formatINR(customerTotal)}</span>
                        </div>
                        <ul class="space-y-2">
                            ${customerOrders.map(order => `
                                <li class="flex justify-between text-sm text-gray-600 border-b border-dashed last:border-b-0 py-1">
                                    <span class="font-medium text-gray-800">Order ID: #${order._id.slice(-6)}</span>
                                    <span class="text-xs text-gray-500">${order.date}</span>
                                    <span class="font-medium text-right">${formatINR(order.total)}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            listContainer.innerHTML = html;
        }

        // FIX: adminRouter persists the last viewed route
        function adminRouter(viewName) {
            lastViewedRoute = viewName; // Update last viewed route
            const titles = {
                'dashboard': 'Dashboard',
                'livestock': 'Livestock',
                'orders': 'Orders',
                'customers': 'Customers',
                'settings': 'Settings'
            };
            const titleEl = document.getElementById('admin-page-title');
            if(titleEl) titleEl.innerText = titles[viewName];

            ['dashboard', 'livestock', 'orders', 'customers', 'settings'].forEach(v => document.getElementById(`admin-view-${v}`)?.classList.add('hidden'));
            document.getElementById(`admin-view-${viewName}`)?.classList.remove('hidden');

            document.querySelectorAll('.admin-nav-item').forEach(btn => {
                if(btn.getAttribute('onclick').includes(viewName)) {
                    btn.classList.add('bg-green-600', 'text-white');
                    btn.classList.remove('text-gray-600', 'hover:bg-green-50', 'hover:text-green-700');
                } else {
                    btn.classList.remove('bg-green-600', 'text-white');
                    btn.classList.add('text-gray-600', 'hover:bg-green-50', 'hover:text-green-700');
                }
            });

            if (viewName === 'livestock') renderLivestock();
            if (viewName === 'orders') renderOrders();
            if (viewName === 'customers') renderCustomers(); 
            
            lucide.createIcons();
        }

        async function saveLivestock(isEdit, id) {
            const name = document.getElementById('new-name').value;
            const type = document.getElementById('new-type').value;
            const breed = document.getElementById('new-breed').value;
            const age = document.getElementById('new-age').value;
            const price = parseFloat(document.getElementById('new-price').value);
            const status = document.getElementById('new-status').value;
            const tags = document.getElementById('new-tags').value;

            if (!name || !type || !breed || !age || isNaN(price) || !status) {
                alert("All required fields must be filled and price must be a number.");
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('type', type);
            formData.append('breed', breed);
            formData.append('age', age);
            formData.append('price', price);
            formData.append('status', status);
            formData.append('tags', tags);

            const imageFile = document.getElementById('new-image').files[0];
            if (imageFile) formData.append('image', imageFile);

            try {
                // NOTE: The server.js provided does not include a PUT route for /admin/livestock/:id, 
                // so the edit functionality (PUT) will likely fail unless the server is updated separately,
                // but we keep the client logic for completeness.
                const url = `${API_URL}/admin/livestock${isEdit ? `/${id}` : ''}`;
                const method = isEdit ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    body: formData
                });
                if (!res.ok) throw new Error(`Failed to ${isEdit ? 'update' : 'add'} livestock`);
                closeLivestockModal();
                document.querySelector('#livestock-modal form').reset();
                await loadData(lastViewedRoute); // Pass the current view to reload to
            } catch (error) {
                console.error(`Error ${isEdit ? 'updating' : 'adding'} livestock:`, error);
                alert(`Error ${isEdit ? 'updating' : 'adding'} livestock. Check console.`);
            }
        }

        // FIX: removeItem calls loadData with the current view
        async function removeItem(id) {
            if (!confirm("Are you sure you want to permanently remove this livestock item?")) {
                return;
            }
            try {
                const res = await fetch(`${API_URL}/admin/livestock/${id}`, {
                    method: 'DELETE',
                });
                if (res.status === 204) {
                    alert("Livestock removed successfully.");
                    await loadData(lastViewedRoute); // Pass the current view to reload to
                } else if (res.status === 404) {
                    alert("Livestock not found.");
                } else {
                    const data = await res.json();
                    alert(`Error removing livestock: ${data.message || 'Server error'}`);
                }
            } catch (error) {
                console.error("Error removing livestock:", error);
                alert("Error removing livestock. Check console.");
            }
        }

        // FIX: nextStatus calls loadData with the current view
        async function nextStatus(id, currentStatus) {
            let next = 'Processing';
            if(currentStatus === 'Processing') next = 'Shipped';
            else if(currentStatus === 'Shipped') next = 'Delivered';
            else return; 

            try {
                await fetch(`${API_URL}/admin/orders/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: next })
                });
                await loadData(lastViewedRoute); // Pass the current view to reload to
            } catch (error) {
                console.error("Error updating order:", error);
                alert("Error updating order. Check console.");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            adminRouter('dashboard');
        });
    </script>
</body>
</html>
